# Эвотор → Google Таблица (v2 для POPUP)

## Что это делает?
Открываешь чек в Эвоторе, нажимаешь закладку — данные добавляются в Google Таблицу.

---

## ШАГ 1: Google Apps Script (5 мин)

1. Открой свою Google Таблицу (лист "Детализация продаж")
2. Скопируй **ID таблицы** из URL: `https://docs.google.com/spreadsheets/d/ВОТ_ЭТОТ_ID/edit`
3. Иди: **Расширения** → **Apps Script**
4. Удали весь код, вставь содержимое файла `google-apps-script.js`
5. Замени `ВСТАВЬ_СЮДА_ID_ТАБЛИЦЫ` на свой ID
6. Сохрани (Ctrl+S)
7. **Развернуть** → **Новое развертывание** → ⚙️ **Веб-приложение**
8. Доступ: **Все (Anyone)**
9. **Скопируй URL** веб-приложения

---

## ШАГ 2: Создай закладку (2 мин)

1. Chrome: **Ctrl+Shift+O** (диспетчер закладок)
2. Правой кнопкой → **Добавить страницу**
3. Название: `Эвотор`

### ВАЖНО: Новый код для POPUP (v2)

В URL вставь этот код (ОДНОЙ СТРОКОЙ), заменив `ВСТАВЬ_СЮДА_URL`:

```
javascript:(function(){const WEBAPP_URL='ВСТАВЬ_СЮДА_URL';function parseCheck(){const result={checkNumber:'',date:'',time:'',paymentType:'',checkTotal:0,items:[]};const allText=document.body.innerText;console.log('=== ЭВОТОР ПАРСЕР v2 ===');const saleMatch=allText.match(/Продажа\s*№?\s*(\d+)/i);if(saleMatch)result.checkNumber=saleMatch[1];const dtMatch=allText.match(/(\d{1,2}:\d{2})\s+(\d{1,2}\.\d{1,2}\.\d{2,4})/);if(dtMatch){result.time=dtMatch[1];let d=dtMatch[2];if(d.match(/\.\d{2}$/))d=d.replace(/(\d{2})$/,'20$1');result.date=d}result.paymentType=allText.includes('Электронная')?'Электронная':allText.includes('Наличные')?'Наличные':'?';const totalMatch=allText.match(/Итого[:\s]*(\d[\d\s]*[,\.]\d{2})/i);if(totalMatch)result.checkTotal=parseFloat(totalMatch[1].replace(/\s/g,'').replace(',','.'));const lines=allText.split('\n').map(l=>l.trim()).filter(l=>l);console.log('Все строки:',lines);let startIdx=-1,endIdx=lines.length;for(let i=0;i<lines.length;i++){if(lines[i].includes('Наименование товара'))startIdx=i;if(startIdx!==-1&&(lines[i].includes('Промежуточный итог')||lines[i].match(/^Итого:/)))endIdx=i}console.log('Диапазон:',startIdx,'-',endIdx);if(startIdx!==-1){let i=startIdx+1;while(i<endIdx){const line=lines[i];if(!line||line.includes('Цена')||line.includes('Кол-во')||line.includes('Скидка на позицию')){i++;continue}if(/[а-яА-ЯёЁa-zA-Z]/.test(line)&&!/^\d/.test(line)){const itemName=line;const price=lines[i+1]||'0';const qty=lines[i+2]||'1';const discount=lines[i+3]||'0';const itemTotal=lines[i+4]||price;console.log('Товар:',itemName,'| Цена:',price,'| Кол-во:',qty);if(/\d/.test(price)&&!price.includes('Цена')&&!price.includes('шт')){result.items.push({name:itemName,unitPrice:parseFloat(price.replace(/[^\d,.-]/g,'').replace(',','.'))||0,qty:parseInt(qty.replace(/[^\d]/g,''))||1,discount:parseFloat(discount.replace(/[^\d,.-]/g,'').replace(',','.'))||0,itemTotal:parseFloat(itemTotal.replace(/[^\d,.-]/g,'').replace(',','.'))||0});i+=5}else i++}else i++}}console.log('Найдено:',result.items.length,result.items);return result}async function sendData(data){const rows=data.items.map(item=>({date:data.date,time:data.time,checkNumber:data.checkNumber,itemName:item.name,volume:'-',qty:item.qty,unitPrice:item.unitPrice,discount:item.discount,itemTotal:item.itemTotal,checkTotal:data.checkTotal,paymentType:data.paymentType}));if(!rows.length){alert('Товары не найдены!\n\nЧек #'+data.checkNumber+'\nF12 → Console для деталей');return}const preview=rows.map(r=>'• '+r.itemName+': '+r.itemTotal+'₽').join('\n');if(!confirm('Чек #'+data.checkNumber+'\n'+data.date+' '+data.time+'\n\n'+preview+'\n\nИтого: '+data.checkTotal+'₽\n\nОтправить?'))return;try{await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({rows})});alert('Отправлено!')}catch(e){alert('Ошибка: '+e)}}const data=parseCheck();if(!data.checkNumber){alert('Чек не найден!');return}sendData(data)})();
```

---

## ШАГ 3: Использование

1. Открой **market.evotor.ru**
2. Кликни на чек → откроется **Детализация чека** (popup)
3. Нажми закладку **Эвотор**
4. Подтверди отправку
5. Данные в таблице!

---

## Если "Товары не найдены"

1. Нажми **F12** → вкладка **Console**
2. Снова нажми закладку Эвотор
3. Скинь мне скриншот консоли — увижу что парсится

---

## Следующие шаги

1. **Автонавигация** - переход по чекам стрелками < >
2. **Telegram** - итоги дня в мессенджер
3. **Vercel** - веб-панель с отчётами
