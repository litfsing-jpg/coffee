# Инструкция: Эвотор → Google Таблица

## Что это делает?
Ты открываешь чек в Эвоторе, нажимаешь закладку в браузере — и данные автоматически добавляются в твою Google Таблицу.

---

## ШАГ 1: Настройка Google Таблицы (5 минут)

### 1.1 Открой свою Google Таблицу
Таблица должна иметь лист "Детализация продаж" с колонками:
```
A: Дата | B: Время | C: № Чека | D: Товар | E: Объём | F: Кол-во | G: Цена за ед. | H: Скидка | I: Сумма товара | J: Итого чека | K: Оплата
```

### 1.2 Скопируй ID таблицы
Из URL таблицы: `https://docs.google.com/spreadsheets/d/ЭТОТ_ID_СКОПИРУЙ/edit`

### 1.3 Создай Apps Script
1. В таблице: **Расширения** → **Apps Script**
2. Удали весь код в редакторе
3. Скопируй код из файла `google-apps-script.js`
4. Замени `ВСТАВЬ_СЮДА_ID_ТАБЛИЦЫ` на ID из шага 1.2
5. Нажми **Сохранить** (Ctrl+S)

### 1.4 Разверни как веб-приложение
1. Нажми **Развернуть** → **Новое развертывание**
2. Нажми шестерёнку ⚙️ → **Веб-приложение**
3. Настройки:
   - Описание: `Эвотор импорт`
   - Выполнять как: `Я`
   - Доступ: `Все` (Anyone)
4. Нажми **Развернуть**
5. **СКОПИРУЙ URL** веб-приложения (он понадобится!)

---

## ШАГ 2: Создание закладки (2 минуты)

### 2.1 Создай новую закладку
1. В Chrome: **Закладки** → **Диспетчер закладок** (Ctrl+Shift+O)
2. Правой кнопкой → **Добавить страницу**
3. Название: `Эвотор → Таблица`

### 2.2 Вставь код
В поле **URL** вставь этот код (ОДНОЙ СТРОКОЙ):

```
javascript:(function(){const WEBAPP_URL='ВСТАВЬ_СЮДА_URL';function parseCheck(){const r={checkNumber:'',date:'',time:'',paymentType:'',checkTotal:0,items:[]};const t=document.body.innerText;const s=t.match(/Продажа\s*№?\s*(\d+)/i);if(s)r.checkNumber=s[1];const d=t.match(/(\d{1,2}:\d{2})\s+(\d{1,2}\.\d{1,2}\.\d{2,4})/);if(d){r.time=d[1];let dt=d[2];if(dt.match(/\d{2}\.\d{2}\.\d{2}$/))dt=dt.replace(/(\d{2})$/,'20$1');r.date=dt}r.paymentType=t.includes('Электронная')?'Электронная':t.includes('Наличные')?'Наличные':'?';const tm=t.match(/Итого[:\s]*(\d[\d\s]*[,\.]\d{2})/i);if(tm)r.checkTotal=parseFloat(tm[1].replace(/\s/g,'').replace(',','.'));document.querySelectorAll('table').forEach(table=>{table.querySelectorAll('tr').forEach((row,i)=>{if(i===0)return;const c=row.querySelectorAll('td');if(c.length>=4){const n=c[0]?.innerText?.trim()||'';const p=c[1]?.innerText?.trim()||'0';const q=c[2]?.innerText?.trim()||'1';const dc=c[3]?.innerText?.trim()||'0';const tt=c[4]?.innerText?.trim()||p;if(n&&!n.includes('Наименование')){r.items.push({name:n,unitPrice:parseFloat(p.replace(/[^\d,.-]/g,'').replace(',','.'))||0,qty:parseInt(q.replace(/[^\d]/g,''))||1,discount:parseFloat(dc.replace(/[^\d,.-]/g,'').replace(',','.'))||0,itemTotal:parseFloat(tt.replace(/[^\d,.-]/g,'').replace(',','.'))||0})}}})});return r}async function send(d){const rows=d.items.map(i=>({date:d.date,time:d.time,checkNumber:d.checkNumber,itemName:i.name,volume:'-',qty:i.qty,unitPrice:i.unitPrice,discount:i.discount,itemTotal:i.itemTotal,checkTotal:d.checkTotal,paymentType:d.paymentType}));if(!rows.length){alert('Товары не найдены!');return}const p=rows.map(r=>`${r.itemName}: ${r.unitPrice}₽`).join('\n');if(!confirm(`Найдено ${rows.length} поз.:\n${p}\n\nОтправить?`))return;try{await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({rows})});alert('Отправлено!')}catch(e){alert('Ошибка: '+e)}}const c=parseCheck();if(!c.checkNumber){alert('Чек не найден!');return}send(c)})();
```

### 2.3 Замени URL
В коде выше замени `ВСТАВЬ_СЮДА_URL` на URL из шага 1.4

---

## ШАГ 3: Использование

1. Открой market.evotor.ru
2. Зайди в раздел с чеками
3. Открой **детализацию чека** (кликни на чек)
4. Нажми закладку **"Эвотор → Таблица"**
5. Подтверди отправку
6. Данные появятся в таблице!

---

## Возможные проблемы

### "Товары не найдены"
- Убедись что открыта именно ДЕТАЛИЗАЦИЯ чека (где видны товары)
- Попробуй прокрутить страницу чтобы таблица товаров загрузилась

### "Чек не найден"
- Убедись что на странице есть номер чека (Продажа №)

### Данные не появляются в таблице
- Проверь URL в закладке
- Проверь ID таблицы в Apps Script
- Проверь название листа (должно быть "Детализация продаж")

---

## Следующие шаги (когда всё заработает)

1. **Автонавигация по чекам** - добавим переход по стрелкам < >
2. **Telegram уведомления** - итоги дня в мессенджер
3. **Веб-панель на Vercel** - красивые отчёты в браузере
